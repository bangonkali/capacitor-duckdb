name: Build Android Native Libraries

on:
  push:
    branches: [main]
    paths:
      - 'scripts/build-android.sh'
      - '.github/workflows/build-android.yml'
      - 'android/**'
      - 'src/**'
      - 'example-app/**'
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      duckdb_version:
        description: 'DuckDB version/branch to build'
        required: false
        default: 'main'
      duckdb_extensions:
        description: 'Extensions to include (semicolon-separated)'
        required: false
        default: 'icu;json;parquet;inet;tpch;tpcds;vss'
      build_spatial:
        description: 'Build with spatial extension'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  DUCKDB_EXTENSIONS: ${{ github.event.inputs.duckdb_extensions || 'icu;json;parquet;inet;tpch;tpcds;vss' }}
  DUCKDB_VERSION: ${{ github.event.inputs.duckdb_version || 'main' }}
  BUILD_SPATIAL: ${{ github.event.inputs.build_spatial || 'true' }}

jobs:
  build:
    runs-on: macos-14  # Apple Silicon runner for faster builds
    timeout-minutes: 120  # 2 hours for spatial builds
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install NDK
        run: |
          sdkmanager --install "ndk;28.0.12433566"
          echo "ANDROID_NDK=$ANDROID_HOME/ndk/28.0.12433566" >> $GITHUB_ENV

      - name: Accept Android SDK Licenses
        run: yes | sdkmanager --licenses || true

      - name: Install Build Tools
        run: |
          brew install cmake ninja

      - name: Setup vcpkg
        if: env.BUILD_SPATIAL == 'true'
        run: |
          git clone https://github.com/Microsoft/vcpkg.git $HOME/vcpkg
          $HOME/vcpkg/bootstrap-vcpkg.sh
          echo "VCPKG_ROOT=$HOME/vcpkg" >> $GITHUB_ENV

      - name: Cache vcpkg dependencies
        if: env.BUILD_SPATIAL == 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/vcpkg/buildtrees
            ~/vcpkg/packages
            ~/vcpkg/downloads
            build/spatial/duckdb-spatial/vcpkg_installed
          key: vcpkg-android-spatial-${{ runner.os }}-${{ hashFiles('scripts/build-android.sh') }}
          restore-keys: |
            vcpkg-android-spatial-${{ runner.os }}-

      - name: Cache DuckDB source
        uses: actions/cache@v4
        with:
          path: |
            build/duckdb/duckdb
            build/spatial/duckdb-spatial
          key: duckdb-source-${{ env.DUCKDB_VERSION }}-${{ github.run_id }}
          restore-keys: |
            duckdb-source-${{ env.DUCKDB_VERSION }}-

      - name: Build DuckDB for Android (with Spatial)
        if: env.BUILD_SPATIAL == 'true'
        run: |
          chmod +x scripts/build-android.sh
          DUCKDB_EXTENSIONS="${{ env.DUCKDB_EXTENSIONS }}" \
          ./scripts/build-android.sh --spatial
        env:
          ANDROID_NDK: ${{ env.ANDROID_NDK }}
          VCPKG_ROOT: ${{ env.VCPKG_ROOT }}

      - name: Build DuckDB for Android (without Spatial)
        if: env.BUILD_SPATIAL != 'true'
        run: |
          chmod +x scripts/build-android.sh
          DUCKDB_EXTENSIONS="${{ env.DUCKDB_EXTENSIONS }}" \
          ./scripts/build-android.sh
        env:
          ANDROID_NDK: ${{ env.ANDROID_NDK }}

      - name: Verify native libraries
        run: |
          echo "=== Checking built libraries ==="
          ls -lh android/src/main/jniLibs/arm64-v8a/
          ls -lh android/src/main/jniLibs/x86_64/
          
          echo ""
          echo "=== Checking for spatial extension symbols ==="
          nm -gC android/src/main/jniLibs/arm64-v8a/libduckdb.so 2>/dev/null | grep -E "(Spatial|Parquet|Json|Icu)Extension" | head -10 || echo "Symbol check complete"

      - name: Build TypeScript Plugin
        run: |
          npm ci || npm install
          npm run build

      - name: Build Example App
        run: |
          cd example-app
          npm ci || npm install
          npm run build
          npx cap sync android

      - name: Build Android Debug APK
        run: |
          cd example-app/android
          chmod +x gradlew
          ./gradlew assembleDebug

      - name: Upload native libraries
        uses: actions/upload-artifact@v4
        with:
          name: duckdb-android-libs
          path: |
            android/src/main/jniLibs/
            android/src/main/cpp/include/
          retention-days: 30

      - name: Upload Example App APK (Debug)
        uses: actions/upload-artifact@v4
        with:
          name: example-app-apk-debug
          path: example-app/android/app/build/outputs/apk/debug/*.apk
          retention-days: 30

      - name: Build Release Assets (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          cd example-app/android
          ./gradlew assembleRelease bundleRelease || echo "Release build requires signing - skipping"

      - name: Create Release Assets Archive
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          # Create native libs archive
          cd android/src/main
          tar -czvf duckdb-android-libs.tar.gz jniLibs/ cpp/include/
          mv duckdb-android-libs.tar.gz ${{ github.workspace }}/
          
          # Copy APK to workspace root for release (debug if release unavailable)
          cp ${{ github.workspace }}/example-app/android/app/build/outputs/apk/release/*.apk \
             ${{ github.workspace }}/example-app-release.apk 2>/dev/null || \
          cp ${{ github.workspace }}/example-app/android/app/build/outputs/apk/debug/*.apk \
             ${{ github.workspace }}/example-app-debug.apk || true

      - name: Upload Release Assets
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            duckdb-android-libs.tar.gz
            example-app-*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
