---
format_version: '23'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
project_type: ios
workflows:

  build_npm_package:
    summary: Build native binaries and create NPM package
    description: |
      Installs dependencies (Ninja, CMake, vcpkg), builds DuckDB native libraries 
      for Android and iOS with Spatial extension, and packs the NPM package.
    steps:
    - git-clone@8:
        inputs:
        - fetch_tags: 'yes'
    - script@1:
        title: Install Dependencies (Ninja, CMake, vcpkg)
        inputs:
        - content: |
            #!/bin/bash
            set -e
            
            echo "Installing Ninja and CMake..."
            brew install ninja cmake
            
            echo "Installing vcpkg..."
            git clone https://github.com/Microsoft/vcpkg.git $HOME/vcpkg
            $HOME/vcpkg/bootstrap-vcpkg.sh
            
            # Expose VCPKG_ROOT for subsequent steps
            envman add --key VCPKG_ROOT --value "$HOME/vcpkg"
    - script@1:
        title: Build Android Binaries
        inputs:
        - content: |
            #!/bin/bash
            set -e
            
            # Ensure VCPKG_ROOT is set
            export VCPKG_ROOT="$HOME/vcpkg"
            
            echo "Building Android binaries with Spatial extension..."
            # Using the recommended extensions list from BUILDING.md
            export DUCKDB_EXTENSIONS="icu;json;parquet;inet;tpch;tpcds;vss"
            ./scripts/build-android.sh --spatial
    - script@1:
        title: Build iOS Binaries
        inputs:
        - content: |
            #!/bin/bash
            set -e
            
            # Ensure VCPKG_ROOT is set
            export VCPKG_ROOT="$HOME/vcpkg"
            
            echo "Building iOS binaries with Spatial extension..."
            ./scripts/build-ios.sh --spatial
    - script@1:
        title: Create NPM Package
        inputs:
        - content: |
            #!/bin/bash
            set -e
            
            echo "Syncing package.json version with git tag..."
            if [[ -n "$BITRISE_GIT_TAG" ]]; then
                # Strip 'v' prefix if present
                VERSION_NUM="${BITRISE_GIT_TAG#v}"
                npm version $VERSION_NUM --no-git-tag-version
            fi

            echo "Installing NPM dependencies..."
            SKIP_BINARY_DOWNLOAD=true npm install
            
            echo "Building TypeScript..."
            npm run build
            
            echo "Packing NPM package..."
            npm pack
            
            # Find the generated tarball
            PKG_FILE=$(ls *.tgz | head -n 1)
            
            # Move the tarball to the deploy directory
            mv "$PKG_FILE" "$BITRISE_DEPLOY_DIR/"
            
            # Expose the full path for the next step
            envman add --key RELEASE_ARCHIVE_PATH --value "$BITRISE_DEPLOY_DIR/$PKG_FILE"

            # Zip Android binaries to preserve structure and avoid name collisions
            cd android/src/main/jniLibs
            zip -r $BITRISE_DEPLOY_DIR/android-libs.zip .
            cd -
            
            # Zip iOS XCFramework
            cd ios/Frameworks
            zip -r $BITRISE_DEPLOY_DIR/DuckDB.xcframework.zip DuckDB.xcframework
            cd -
    - github-release@0:
        inputs:
        - api_token: "$GITHUB_ACCESS_TOKEN"
        - username: "$GITHUB_USERNAME"
        - repository_url: https://github.com/bangonkali/capacitor-duckdb
        - tag: "$BITRISE_GIT_TAG"
        - name: "$BITRISE_GIT_TAG"
        - body: "Automated release from Bitrise build $BITRISE_BUILD_NUMBER"
        - draft: "no"
        - files_to_upload: |-
            $RELEASE_ARCHIVE_PATH
            $BITRISE_DEPLOY_DIR/android-libs.zip
            $BITRISE_DEPLOY_DIR/DuckDB.xcframework.zip
    - script@1:
        title: Authenticate with NPM
        inputs:
        - content: |
            #!/bin/bash
            set -e
            echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > .npmrc
    - script@1:
        title: Publish to NPM
        inputs:
        - content: |
            #!/bin/bash
            set -e
            # Only publish if we are on a tag
            if [[ -n "$BITRISE_GIT_TAG" ]]; then
                echo "Publishing version $BITRISE_GIT_TAG to NPM..."
                npm publish --access public
            else
                echo "Not a tagged build, skipping NPM publish."
            fi
    - deploy-to-bitrise-io@2: {}
    triggers:
      tag:
      - name: "v*"
meta:
  bitrise.io:
    stack: osx-xcode-16.4.x
    machine_type_id: g2.mac.large
